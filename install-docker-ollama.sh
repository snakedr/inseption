#!/bin/bash

################################################################################
# Install Docker –∏ Ollama –Ω–∞ Debian 13.2
# 
# –û–ø–∏—Å–∞–Ω–∏–µ: –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker CE –∏ Ollama
#          —á–µ—Ä–µ–∑ docker-compose —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π CPU
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: chmod +x install-docker-ollama.sh && ./install-docker-ollama.sh
#
# –ê–≤—Ç–æ—Ä: Setup Script for Docker + Ollama
# –î–∞—Ç–∞: 2025
################################################################################

set -e  # –í—ã—Ö–æ–¥ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[‚úì]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[‚ö†]${NC} $1"
}

log_error() {
    echo -e "${RED}[‚úó]${NC} $1"
}

################################################################################
# 1. –£–°–¢–ê–ù–û–í–ö–ê DOCKER –ù–ê DEBIAN 13.2
################################################################################

install_docker() {
    log_info "–ù–∞—á–∏–Ω–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É Docker..."

    # 1.1 –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    log_info "–û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    sudo apt update
    sudo apt install -y ca-certificates curl gnupg lsb-release
    log_success "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

    # 1.2 –î–æ–±–∞–≤–ª—è–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π GPG-–∫–ª—é—á Docker
    log_info "–î–æ–±–∞–≤–ª—è–µ–º GPG-–∫–ª—é—á Docker..."
    sudo install -m 0755 -d /etc/apt/keyrings

    curl -fsSL https://download.docker.com/linux/debian/gpg | \
        sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

    sudo chmod a+r /etc/apt/keyrings/docker.gpg
    log_success "GPG-–∫–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω"

    # 1.3 –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π Docker
    log_info "–î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π Docker..."
    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
      https://download.docker.com/linux/debian \
      $(lsb_release -cs) stable" | \
      sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    log_success "–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω"

    # 1.4 –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker
    log_info "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker CE –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã..."
    sudo apt update
    sudo apt install -y docker-ce docker-ce-cli containerd.io \
        docker-buildx-plugin docker-compose-plugin
    log_success "Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

    # 1.5 –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏–∏
    log_info "–ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏–∏..."
    docker --version
    docker compose version
    log_success "–í–µ—Ä—Å–∏–∏ Docker –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã"

    # 1.6 –ó–∞–ø—É—Å–∫ Docker –±–µ–∑ sudo (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
    log_info "–î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É docker..."
    sudo usermod -aG docker "$USER"
    
    log_warning "–î–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∞–≤ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ—Å—å –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: newgrp docker"
}

################################################################################
# 2. –ü–†–û–í–ï–†–ö–ê DOCKER
################################################################################

verify_docker() {
    log_info "–ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É Docker..."
    
    if docker run hello-world > /dev/null 2>&1; then
        log_success "Docker —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
        return 0
    else
        log_error "Docker –Ω–µ –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É"
        return 1
    fi
}

################################################################################
# 3. –£–°–¢–ê–ù–û–í–ö–ê OLLAMA –ß–ï–†–ï–ó DOCKER-COMPOSE
################################################################################

setup_ollama() {
    log_info "–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Ollama..."

    # 3.1 –°–æ–∑–¥–∞—ë–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    OLLAMA_DIR="$HOME/ollama"
    log_info "–°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: $OLLAMA_DIR"
    mkdir -p "$OLLAMA_DIR"
    cd "$OLLAMA_DIR"
    log_success "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞"

    # 3.2 –°–æ–∑–¥–∞—ë–º docker-compose.yml (CPU –≤–µ—Ä—Å–∏—è)
    log_info "–°–æ–∑–¥–∞–µ–º docker-compose.yml..."
    cat > docker-compose.yml << 'EOF'

services:
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_KEEP_ALIVE=24h

volumes:
  ollama_data:
EOF
    log_success "docker-compose.yml —Å–æ–∑–¥–∞–Ω"

    # 3.3 –ó–∞–ø—É—Å–∫–∞–µ–º Ollama
    log_info "–ó–∞–ø—É—Å–∫–∞–µ–º Ollama –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
    docker compose up -d
    log_success "Ollama –∑–∞–ø—É—â–µ–Ω–∞"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
    sleep 3
    log_info "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
    docker ps --filter "name=ollama"
}

################################################################################
# 4. –ü–†–û–í–ï–†–ö–ê –†–ê–ë–û–¢–´ OLLAMA
################################################################################

verify_ollama() {
    log_info "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É Ollama API..."

    # 4.1 –ü—Ä–æ–≤–µ—Ä—è–µ–º API
    if curl -s http://localhost:11434 | grep -q "Ollama is running"; then
        log_success "Ollama API –æ—Ç–≤–µ—á–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
        return 0
    else
        log_warning "Ollama –º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∑–∞–≥—Ä—É–∑–∫–∏, –ø–æ–¥–æ–∂–¥–∏—Ç–µ..."
        return 1
    fi
}

################################################################################
# 5. –ó–ê–ì–†–£–ó–ö–ê –ú–û–î–ï–õ–ò
################################################################################

load_model() {
    local model="${1:-llama3}"
    log_info "–ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å: $model"
    docker exec -it ollama ollama pull "$model"
    log_success "–ú–æ–¥–µ–ª—å $model –∑–∞–≥—Ä—É–∂–µ–Ω–∞"
}

################################################################################
# 6. –ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ê–ù–î–´ (–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
################################################################################

show_commands() {
    cat << 'EOF'

‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                         –ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ê–ù–î–´                                   ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üìå –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê:
   docker ps                           # –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
   docker logs -f ollama               # –õ–æ–≥–∏ Ollama –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

üìå –†–ê–ë–û–¢–ê –° –ú–û–î–ï–õ–Ø–ú–ò:
   docker exec -it ollama ollama pull <–º–æ–¥–µ–ª—å>     # –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å
   docker exec -it ollama ollama run <–º–æ–¥–µ–ª—å>      # –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–¥–µ–ª—å
   docker exec -it ollama ollama list               # –°–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π

üìå API –ó–ê–ü–†–û–°–´:
   # –ü—Ä–æ–≤–µ—Ä–∫–∞ API
   curl http://localhost:11434

   # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
   curl http://localhost:11434/api/generate -d '{
     "model": "llama3",
     "prompt": "–ü—Ä–∏–≤–µ—Ç! –ö—Ç–æ —Ç—ã?"
   }'

üìå –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–ù–¢–ï–ô–ù–ï–†–û–ú:
   docker compose down                 # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Ollama
   docker compose up -d                # –ó–∞–ø—É—Å—Ç–∏—Ç—å Ollama
   docker compose pull                 # –û–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–∑
   docker compose up -d                # –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å

   –û–ß–ò–°–¢–ö–ê:
   docker system prune -a              # –£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã
   docker volume rm ollama_data        # –£–¥–∞–ª–∏—Ç—å volume (WARNING: –ø–æ—Ç–µ—Ä—è –º–æ–¥–µ–ª–µ–π!)

EOF
}

################################################################################
# –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ
################################################################################

show_menu() {
    cat << 'EOF'

‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë     –£–°–¢–ê–ù–û–í–ö–ê DOCKER –ò OLLAMA –ù–ê DEBIAN 13.2                              ‚ïë
‚ïë     Setup Script for Docker + Ollama                                       ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:

  1) –ü–æ–ª–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (Docker + Ollama)
  2) –¢–æ–ª—å–∫–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker
  3) –¢–æ–ª—å–∫–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Ollama
  4) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Docker
  5) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Ollama
  6) –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å Ollama
  7) –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
  0) –í—ã—Ö–æ–¥

EOF
}

################################################################################
# –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ
################################################################################

main() {
    log_info "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ Docker + Ollama"

    while true; do
        show_menu
        read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä: " choice

        case $choice in
            1)
                install_docker
                verify_docker && log_success "Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" || log_error "–û—à–∏–±–∫–∞ Docker"
                setup_ollama
                sleep 5
                verify_ollama && log_success "Ollama –≥–æ—Ç–æ–≤–∞" || log_warning "Ollama –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è"
                log_info "–•–æ—Ç–∏—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å? (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é llama3)"
                read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞: " model
                if [ -n "$model" ]; then
                    load_model "$model"
                fi
                show_commands
                ;;
            2)
                install_docker
                verify_docker && log_success "Docker –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é"
                ;;
            3)
                setup_ollama
                sleep 5
                verify_ollama
                ;;
            4)
                verify_docker
                ;;
            5)
                verify_ollama
                ;;
            6)
                read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é llama3): " model
                load_model "${model:-llama3}"
                ;;
            7)
                show_commands
                ;;
            0)
                log_info "–î–æ —Å–≤–∏–¥–∞–Ω–∏—è!"
                exit 0
                ;;
            *)
                log_error "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
                ;;
        esac

        echo ""
        read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è..."
    done
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–∫—Ä–∏–ø—Ç —Å sudo –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
if [[ $EUID -ne 0 ]] && [[ "${1:-}" != "menu" ]]; then
    # –ü–æ–∑–≤–æ–ª—è–µ–º –∑–∞–ø—É—Å–∫ –±–µ–∑ sudo, –Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º
    log_warning "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã —Ç—Ä–µ–±—É—é—Ç –ø—Ä–∞–≤ sudo. –í—ã –±—É–¥–µ—Ç–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å—Å—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏."
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
main
